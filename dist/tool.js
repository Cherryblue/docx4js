'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var isNode = false;
try {
	isNode = Object.prototype.toString.call(global.process) === '[object process]';
} catch (e) {}

function makeTool(xmlParser, Document, Node, NodeList, scopable) {
	var $ = {
		isNode: isNode,
		parseXML: xmlParser,
		extend: Object.assign,
		isFunction: function isFunction(a) {
			return typeof a === 'function';
		},
		isArray: function isArray(a) {
			return Array.isArray(a);
		},
		each: function each(a, f, ctx) {
			if (Array.isArray(a)) {
				a.forEach(f, ctx);
			} else if ((typeof a === 'undefined' ? 'undefined' : _typeof(a)) === 'object') {
				Object.keys(a).forEach(function (k) {
					f.call(ctx, k, a[k]);
				});
			}
		},
		map: function map(a, f, ctx) {
			return a.map(f, ctx);
		}
	};

	$.extend($, {
		toArray: function toArray(args) {
			var a = [];
			for (var i = 0, len = args.length; i < len; i++) {
				a.push(args[i]);
			}return a;
		}
	});

	var directChildSelector = /((^|,)\s*>)/,
	    id = "sxxx";
	$.extend(Node.prototype, {
		$: function $(selector) {
			if (!directChildSelector.test(selector)) return this.querySelectorAll(selector);else if (scopable) return this.querySelectorAll(selector.split(',').map(function (a) {
				return a.trim().charAt(0) == '>' ? ':scope' + a : a;
			}).join(','));else if (this.id) {
				return this.querySelectorAll(selector.split(',').map(function (a) {
					//return  '#'+this.id+((a=a.trim()).charAt(0)=='>' ? '' : ' ')+a
					return (a = a.trim()).charAt(0) == '>' ? a.substring(1) : a;
				}, this).join(','));
			} else {
				this.id = id;
				var nodes = this.querySelectorAll(selector.split(',').map(function (a) {
					//IE can't find '#xx', @todo: fix it later
					//return  '#'+this.id+((a=a.trim()).charAt(0)=='>' ? '' : ' ')+a
					return (a = a.trim()).charAt(0) == '>' ? a.substring(1) : a;
				}, this).join(','));
				delete this.id;
				return nodes;
			}
		},
		$1: function $1(selector) {
			if (!directChildSelector.test(selector)) return this.querySelector(selector);else if (scopable) return this.querySelector(selector.split(',').map(function (a) {
				return (a = a.trim()).charAt(0) == '>' ? ':scope' + a : a;
			}).join(','));else if (this.id) {
				return this.querySelector(selector.split(',').map(function (a) {
					//return  '#'+this.id+((a=a.trim()).charAt(0)=='>' ? '' : ' ')+a
					return (a = a.trim()).charAt(0) == '>' ? a.substring(1) : a;
				}, this).join(','));
			} else {
				this.id = id;
				var nodes = this.querySelector(selector.split(',').map(function (a) {
					//return  '#'+this.id+((a=a.trim()).charAt(0)=='>' ? '' : ' ')+a
					return (a = a.trim()).charAt(0) == '>' ? a.substring(1) : a;
				}, this).join(','));
				delete this.id;
				return nodes;
			}
		},
		attr: function attr(name, value) {
			if (arguments.length == 1) {
				var attr = this.attributes.getNamedItem(name);
				return attr ? attr.value : undefined;
			} else if (value == null) this.removeAttribute(name);else this.setAttribute(name, value);
		},
		remove: Node.prototype.remove || function () {
			this.parentNode.removeChild(this);
		},
		uptrim: function uptrim() {
			var parent = this.parentNode;
			this.remove();
			if (parent.childNodes.length == 0) parent.uptrim();
		}
	});

	$.extend(NodeList.prototype, {
		asArray: function asArray(o) {
			o = o || [];
			for (var i = 0, len = this.length; i < len; i++) {
				o.push(this[i]);
			}return o;
		},
		forEach: Array.prototype.forEach,
		map: Array.prototype.map
	});

	return $;
}

if (!isNode) {
	window.$ = makeTool.apply(undefined, _toConsumableArray(function () {
		function parser(x) {
			x = x.trim();
			if (typeof DOMParser != 'undefined') return new DOMParser().parseFromString(x, "text/xml");

			var xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
			xmlDoc.async = "false";
			xmlDoc.loadXML(x);
			return xmlDoc;
		}

		function supportScopeSelector() {
			try {
				return document.body.querySelector(':scope>*').length != 0;
			} catch (e) {
				return false;
			}
		}
		document.$1 = document.querySelector;
		document.$ = document.querySelectorAll;
		return [parser, Document, Element, NodeList, supportScopeSelector()];
	}()));
} else {
	global.$ = makeTool.apply(undefined, _toConsumableArray(function (xmldom) {
		var DOMParser = xmldom.DOMParser,
		    DOMImplementation = xmldom.DOMImplementation;

		var nwmatcher = require("nwmatcher");

		function parse(x) {
			return new DOMParser().parseFromString(x, "text/xml");
		}

		function addNwmatcher(document) {
			if (!document._nwmatcher) {
				document._nwmatcher = nwmatcher({ document: document });
				document._nwmatcher.configure({ UNIQUE_ID: false });
			}
			return document._nwmatcher;
		}

		var a = parse('<a></a>'),
		    Document = a.constructor,
		    Element = a.documentElement.constructor,
		    NodeList = a.childNodes.constructor;

		Document.prototype.querySelector = Element.prototype.querySelector = function (selector) {
			return addNwmatcher(this.ownerDocument || this).first(selector, this);
		};

		Document.prototype.querySelectorAll = Element.prototype.querySelectorAll = function (selector) {
			return addNwmatcher(this.ownerDocument || this).select(selector, this);
		};

		/**
   * nwwatcher has unexpected result with namespace on nodeName
   */
		var _createElementNS = Document.prototype.createElementNS;
		Document.prototype.createElementNS = function () {
			var el = _createElementNS.apply(this, arguments);
			el.tagName = el.nodeName = el.localName;
			return el;
		};

		return [parse, Document, Element, NodeList, false];
	}(require('xmldom'))));
}
//# sourceMappingURL=data:application/json;base64,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RSxVQUFGLENBQWEsV0FBYixDQXJCMkI7O0FBdUJyQyxXQUFTLFNBQVQsQ0FBbUIsYUFBbkIsR0FBaUMsUUFBUSxTQUFSLENBQWtCLGFBQWxCLEdBQWdDLFVBQVMsUUFBVCxFQUFrQjtBQUNsRixVQUFPLGFBQWEsS0FBSyxhQUFMLElBQW9CLElBQXBCLENBQWIsQ0FBdUMsS0FBdkMsQ0FBNkMsUUFBN0MsRUFBdUQsSUFBdkQsQ0FBUCxDQURrRjtHQUFsQixDQXZCNUI7O0FBMkJyQyxXQUFTLFNBQVQsQ0FBbUIsZ0JBQW5CLEdBQW9DLFFBQVEsU0FBUixDQUFrQixnQkFBbEIsR0FBbUMsVUFBUyxRQUFULEVBQWtCO0FBQ3hGLFVBQU8sYUFBYSxLQUFLLGFBQUwsSUFBb0IsSUFBcEIsQ0FBYixDQUF1QyxNQUF2QyxDQUE4QyxRQUE5QyxFQUF3RCxJQUF4RCxDQUFQLENBRHdGO0dBQWxCOzs7OztBQTNCbEMsTUFrQ2pDLG1CQUFpQixTQUFTLFNBQVQsQ0FBbUIsZUFBbkIsQ0FsQ2dCO0FBbUNyQyxXQUFTLFNBQVQsQ0FBbUIsZUFBbkIsR0FBbUMsWUFBVTtBQUM1QyxPQUFJLEtBQUcsaUJBQWlCLEtBQWpCLENBQXVCLElBQXZCLEVBQTRCLFNBQTVCLENBQUgsQ0FEd0M7QUFFNUMsTUFBRyxPQUFILEdBQVcsR0FBRyxRQUFILEdBQVksR0FBRyxTQUFILENBRnFCO0FBRzVDLFVBQU8sRUFBUCxDQUg0QztHQUFWLENBbkNFOztBQTBDckMsU0FBTyxDQUFDLEtBQUQsRUFBUSxRQUFSLEVBQWtCLE9BQWxCLEVBQTJCLFFBQTNCLEVBQXFDLEtBQXJDLENBQVAsQ0ExQ3FDO0VBQWhCLENBMkNuQixRQUFRLFFBQVIsQ0EzQ2tCLEVBQVosQ0FBVCxDQURJO0NBeEJMIiwiZmlsZSI6InRvb2wuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaXNOb2RlPWZhbHNlXG50cnkge1xuXHRpc05vZGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZ2xvYmFsLnByb2Nlc3MpID09PSAnW29iamVjdCBwcm9jZXNzXScgXG59IGNhdGNoKGUpIHtcblx0XG59XG5cblxuZnVuY3Rpb24gbWFrZVRvb2woeG1sUGFyc2VyLCBEb2N1bWVudCwgTm9kZSwgTm9kZUxpc3QsIHNjb3BhYmxlKXtcblx0dmFyICQ9e1xuXHRcdGlzTm9kZSxcblx0XHRwYXJzZVhNTDogeG1sUGFyc2VyLFxuXHRcdGV4dGVuZDogT2JqZWN0LmFzc2lnbixcblx0XHRpc0Z1bmN0aW9uOiBmdW5jdGlvbihhKXtcblx0XHRcdHJldHVybiB0eXBlb2YgYSA9PT0nZnVuY3Rpb24nXG5cdFx0fSxcblx0XHRpc0FycmF5OiBmdW5jdGlvbihhKXtcblx0XHRcdHJldHVybiBBcnJheS5pc0FycmF5KGEpXG5cdFx0fSxcblx0XHRlYWNoOiBmdW5jdGlvbihhLGYsY3R4KXtcblx0XHRcdGlmKEFycmF5LmlzQXJyYXkoYSkpe1xuXHRcdFx0XHRhLmZvckVhY2goZixjdHgpXG5cdFx0XHR9ZWxzZSBpZih0eXBlb2YgYSA9PT0nb2JqZWN0Jyl7XG5cdFx0XHRcdE9iamVjdC5rZXlzKGEpLmZvckVhY2goZnVuY3Rpb24oayl7XG5cdFx0XHRcdFx0Zi5jYWxsKGN0eCxrLGFba10pXG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fSxcblx0XHRtYXA6IGZ1bmN0aW9uKGEsZixjdHgpe1xuXHRcdFx0cmV0dXJuIGEubWFwKGYsY3R4KVxuXHRcdH1cblx0fTtcblxuXHQkLmV4dGVuZCgkLHtcblx0XHR0b0FycmF5OiBmdW5jdGlvbihhcmdzKXtcblx0XHRcdHZhciBhPVtdO1xuXHRcdFx0Zm9yKHZhciBpPTAsbGVuPWFyZ3MubGVuZ3RoO2k8bGVuO2krKylcblx0XHRcdFx0YS5wdXNoKGFyZ3NbaV0pXG5cdFx0XHRyZXR1cm4gYVxuXHRcdH1cblx0fSlcblxuXHR2YXIgZGlyZWN0Q2hpbGRTZWxlY3Rvcj0vKChefCwpXFxzKj4pLywgaWQ9XCJzeHh4XCJcblx0JC5leHRlbmQoTm9kZS5wcm90b3R5cGUse1xuXHRcdCQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXtcblx0XHRcdGlmKCFkaXJlY3RDaGlsZFNlbGVjdG9yLnRlc3Qoc2VsZWN0b3IpKVxuXHRcdFx0XHRyZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKVxuXHRcdFx0ZWxzZSBpZihzY29wYWJsZSlcblx0XHRcdFx0cmV0dXJuIHRoaXMucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvci5zcGxpdCgnLCcpLm1hcChmdW5jdGlvbihhKXtcblx0XHRcdFx0XHRcdHJldHVybiBhLnRyaW0oKS5jaGFyQXQoMCk9PSc+JyA/ICc6c2NvcGUnK2EgOiBhXG5cdFx0XHRcdFx0fSkuam9pbignLCcpKVxuXHRcdFx0ZWxzZSBpZih0aGlzLmlkKXtcblx0XHRcdFx0cmV0dXJuIHRoaXMucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvci5zcGxpdCgnLCcpLm1hcChmdW5jdGlvbihhKXtcblx0XHRcdFx0XHRcdC8vcmV0dXJuICAnIycrdGhpcy5pZCsoKGE9YS50cmltKCkpLmNoYXJBdCgwKT09Jz4nID8gJycgOiAnICcpK2Fcblx0XHRcdFx0XHRcdHJldHVybiAoYT1hLnRyaW0oKSkuY2hhckF0KDApPT0nPicgPyBhLnN1YnN0cmluZygxKSA6IGFcblx0XHRcdFx0XHR9LHRoaXMpLmpvaW4oJywnKSlcblx0XHRcdH1lbHNle1xuXHRcdFx0XHR0aGlzLmlkPWlkXG5cdFx0XHRcdHZhciBub2Rlcz10aGlzLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3Iuc3BsaXQoJywnKS5tYXAoZnVuY3Rpb24oYSl7XG5cdFx0XHRcdFx0XHQvL0lFIGNhbid0IGZpbmQgJyN4eCcsIEB0b2RvOiBmaXggaXQgbGF0ZXJcblx0XHRcdFx0XHRcdC8vcmV0dXJuICAnIycrdGhpcy5pZCsoKGE9YS50cmltKCkpLmNoYXJBdCgwKT09Jz4nID8gJycgOiAnICcpK2Fcblx0XHRcdFx0XHRcdHJldHVybiAoYT1hLnRyaW0oKSkuY2hhckF0KDApPT0nPicgPyBhLnN1YnN0cmluZygxKSA6IGFcblx0XHRcdFx0XHR9LHRoaXMpLmpvaW4oJywnKSlcblx0XHRcdFx0ZGVsZXRlIHRoaXMuaWRcblx0XHRcdFx0cmV0dXJuIG5vZGVzXG5cdFx0XHR9XG5cdFx0fSxcblx0XHQkMTpmdW5jdGlvbihzZWxlY3Rvcil7XG5cdFx0XHRpZighZGlyZWN0Q2hpbGRTZWxlY3Rvci50ZXN0KHNlbGVjdG9yKSlcblx0XHRcdFx0cmV0dXJuIHRoaXMucXVlcnlTZWxlY3RvcihzZWxlY3Rvcilcblx0XHRcdGVsc2UgaWYoc2NvcGFibGUpXG5cdFx0XHRcdHJldHVybiB0aGlzLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3Iuc3BsaXQoJywnKS5tYXAoZnVuY3Rpb24oYSl7XG5cdFx0XHRcdFx0XHRyZXR1cm4gKGE9YS50cmltKCkpLmNoYXJBdCgwKT09Jz4nID8gJzpzY29wZScrYSA6IGFcblx0XHRcdFx0XHR9KS5qb2luKCcsJykpXG5cdFx0XHRlbHNlIGlmKHRoaXMuaWQpe1xuXHRcdFx0XHRyZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yLnNwbGl0KCcsJykubWFwKGZ1bmN0aW9uKGEpe1xuXHRcdFx0XHRcdFx0Ly9yZXR1cm4gICcjJyt0aGlzLmlkKygoYT1hLnRyaW0oKSkuY2hhckF0KDApPT0nPicgPyAnJyA6ICcgJykrYVxuXHRcdFx0XHRcdFx0cmV0dXJuIChhPWEudHJpbSgpKS5jaGFyQXQoMCk9PSc+JyA/IGEuc3Vic3RyaW5nKDEpIDogYVxuXHRcdFx0XHRcdH0sdGhpcykuam9pbignLCcpKVxuXHRcdFx0fWVsc2V7XG5cdFx0XHRcdHRoaXMuaWQ9aWRcblx0XHRcdFx0dmFyIG5vZGVzPXRoaXMucXVlcnlTZWxlY3RvcihzZWxlY3Rvci5zcGxpdCgnLCcpLm1hcChmdW5jdGlvbihhKXtcblx0XHRcdFx0XHRcdC8vcmV0dXJuICAnIycrdGhpcy5pZCsoKGE9YS50cmltKCkpLmNoYXJBdCgwKT09Jz4nID8gJycgOiAnICcpK2Fcblx0XHRcdFx0XHRcdHJldHVybiAoYT1hLnRyaW0oKSkuY2hhckF0KDApPT0nPicgPyBhLnN1YnN0cmluZygxKSA6IGFcblx0XHRcdFx0XHR9LHRoaXMpLmpvaW4oJywnKSlcblx0XHRcdFx0ZGVsZXRlIHRoaXMuaWRcblx0XHRcdFx0cmV0dXJuIG5vZGVzXG5cdFx0XHR9XG5cdFx0fSxcblx0XHRhdHRyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7XG5cdFx0XHRpZihhcmd1bWVudHMubGVuZ3RoPT0xKXtcblx0XHRcdFx0dmFyIGF0dHI9dGhpcy5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKVxuXHRcdFx0XHRyZXR1cm4gYXR0ciA/IGF0dHIudmFsdWUgOiB1bmRlZmluZWRcblx0XHRcdH1lbHNlIGlmKHZhbHVlPT1udWxsKVxuXHRcdFx0XHR0aGlzLnJlbW92ZUF0dHJpYnV0ZShuYW1lKVxuXHRcdFx0ZWxzZVxuXHRcdFx0XHR0aGlzLnNldEF0dHJpYnV0ZShuYW1lLHZhbHVlKVxuXHRcdH0sXG5cdFx0cmVtb3ZlOiBOb2RlLnByb3RvdHlwZS5yZW1vdmUgfHwgZnVuY3Rpb24oKXtcblx0XHRcdHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKVxuXHRcdH0sXG5cdFx0dXB0cmltOiBmdW5jdGlvbigpe1xuXHRcdFx0dmFyIHBhcmVudD10aGlzLnBhcmVudE5vZGVcblx0XHRcdHRoaXMucmVtb3ZlKClcblx0XHRcdGlmKHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aD09MClcblx0XHRcdFx0cGFyZW50LnVwdHJpbSgpXG5cdFx0fVxuXHR9KVxuXG5cdCQuZXh0ZW5kKE5vZGVMaXN0LnByb3RvdHlwZSx7XG5cdFx0YXNBcnJheTogZnVuY3Rpb24obyl7XG5cdFx0XHRvPW98fFtdXG5cdFx0XHRmb3IodmFyIGk9MCxsZW49dGhpcy5sZW5ndGg7aTxsZW47aSsrKVxuXHRcdFx0XHRvLnB1c2godGhpc1tpXSlcblx0XHRcdHJldHVybiBvXG5cdFx0fSxcblx0XHRmb3JFYWNoOiBBcnJheS5wcm90b3R5cGUuZm9yRWFjaCxcblx0XHRtYXA6IEFycmF5LnByb3RvdHlwZS5tYXBcblx0fSlcblxuXHRyZXR1cm4gJFxufVxuXG5cbmlmKCFpc05vZGUpe1xuXHR3aW5kb3cuJD1tYWtlVG9vbCguLi4oZnVuY3Rpb24oKXtcblx0ICAgIGZ1bmN0aW9uIHBhcnNlcih4KXtcblx0ICAgICAgICB4PXgudHJpbSgpXG5cdCAgICAgICAgaWYodHlwZW9mKERPTVBhcnNlcikhPSd1bmRlZmluZWQnKVxuXHQgICAgICAgICAgICByZXR1cm4gKCBuZXcgRE9NUGFyc2VyKCkgKS5wYXJzZUZyb21TdHJpbmcoeCwgXCJ0ZXh0L3htbFwiKTtcblxuXHQgICAgICAgIHZhciB4bWxEb2MgPSBuZXcgQWN0aXZlWE9iamVjdChcIk1pY3Jvc29mdC5YTUxET01cIik7XG5cdCAgICAgICAgeG1sRG9jLmFzeW5jID0gXCJmYWxzZVwiO1xuXHQgICAgICAgIHhtbERvYy5sb2FkWE1MKHgpO1xuXHQgICAgICAgIHJldHVybiB4bWxEb2M7XG5cdCAgICB9XG5cblx0ICAgIGZ1bmN0aW9uIHN1cHBvcnRTY29wZVNlbGVjdG9yKCl7XG5cdCAgICAgICAgdHJ5e1xuXHQgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCc6c2NvcGU+KicpLmxlbmd0aCE9MFxuXHQgICAgICAgIH1jYXRjaChlKXtcblx0ICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG5cdCAgICAgICAgfVxuXHQgICAgfVxuXHQgICAgZG9jdW1lbnQuJDE9ZG9jdW1lbnQucXVlcnlTZWxlY3RvclxuXHQgICAgZG9jdW1lbnQuJD1kb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsXG5cdCAgICByZXR1cm4gW3BhcnNlciwgRG9jdW1lbnQsIEVsZW1lbnQsIE5vZGVMaXN0LCBzdXBwb3J0U2NvcGVTZWxlY3RvcigpXVxuXHR9KSgpKVxufWVsc2V7XG5cdGdsb2JhbC4kPW1ha2VUb29sKC4uLihmdW5jdGlvbih4bWxkb20pe1xuXHRcdHZhciBET01QYXJzZXI9eG1sZG9tLkRPTVBhcnNlcixcblx0XHRcdERPTUltcGxlbWVudGF0aW9uPXhtbGRvbS5ET01JbXBsZW1lbnRhdGlvbjtcblxuXHRcdHZhciBud21hdGNoZXIgPSByZXF1aXJlKFwibndtYXRjaGVyXCIpO1xuXG5cdFx0ZnVuY3Rpb24gcGFyc2UoeCl7XG5cdFx0XHRyZXR1cm4gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh4LCBcInRleHQveG1sXCIpXG5cdFx0fVxuXG5cdFx0ZnVuY3Rpb24gYWRkTndtYXRjaGVyKGRvY3VtZW50KSB7XG5cdFx0XHRpZiAoIWRvY3VtZW50Ll9ud21hdGNoZXIpIHtcblx0XHRcdFx0ZG9jdW1lbnQuX253bWF0Y2hlciA9IG53bWF0Y2hlcih7IGRvY3VtZW50OiBkb2N1bWVudCB9KTtcblx0XHRcdFx0ZG9jdW1lbnQuX253bWF0Y2hlci5jb25maWd1cmUoeyBVTklRVUVfSUQ6IGZhbHNlIH0pO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGRvY3VtZW50Ll9ud21hdGNoZXI7XG5cdFx0fVxuXG5cdFx0dmFyIGE9cGFyc2UoJzxhPjwvYT4nKSxcblx0XHRcdERvY3VtZW50PWEuY29uc3RydWN0b3IsXG5cdFx0XHRFbGVtZW50PWEuZG9jdW1lbnRFbGVtZW50LmNvbnN0cnVjdG9yLFxuXHRcdFx0Tm9kZUxpc3Q9YS5jaGlsZE5vZGVzLmNvbnN0cnVjdG9yXG5cblx0XHREb2N1bWVudC5wcm90b3R5cGUucXVlcnlTZWxlY3Rvcj1FbGVtZW50LnByb3RvdHlwZS5xdWVyeVNlbGVjdG9yPWZ1bmN0aW9uKHNlbGVjdG9yKXtcblx0XHRcdHJldHVybiBhZGROd21hdGNoZXIodGhpcy5vd25lckRvY3VtZW50fHx0aGlzKS5maXJzdChzZWxlY3RvciwgdGhpcyk7XG5cdFx0fVxuXG5cdFx0RG9jdW1lbnQucHJvdG90eXBlLnF1ZXJ5U2VsZWN0b3JBbGw9RWxlbWVudC5wcm90b3R5cGUucXVlcnlTZWxlY3RvckFsbD1mdW5jdGlvbihzZWxlY3Rvcil7XG5cdFx0XHRyZXR1cm4gYWRkTndtYXRjaGVyKHRoaXMub3duZXJEb2N1bWVudHx8dGhpcykuc2VsZWN0KHNlbGVjdG9yLCB0aGlzKTtcblx0XHR9XG5cblx0XHQvKipcblx0XHQgKiBud3dhdGNoZXIgaGFzIHVuZXhwZWN0ZWQgcmVzdWx0IHdpdGggbmFtZXNwYWNlIG9uIG5vZGVOYW1lXG5cdFx0ICovXG5cdFx0dmFyIF9jcmVhdGVFbGVtZW50TlM9RG9jdW1lbnQucHJvdG90eXBlLmNyZWF0ZUVsZW1lbnROU1xuXHRcdERvY3VtZW50LnByb3RvdHlwZS5jcmVhdGVFbGVtZW50TlM9ZnVuY3Rpb24oKXtcblx0XHRcdHZhciBlbD1fY3JlYXRlRWxlbWVudE5TLmFwcGx5KHRoaXMsYXJndW1lbnRzKVxuXHRcdFx0ZWwudGFnTmFtZT1lbC5ub2RlTmFtZT1lbC5sb2NhbE5hbWVcblx0XHRcdHJldHVybiBlbFxuXHRcdH1cblxuXG5cdFx0cmV0dXJuIFtwYXJzZSwgRG9jdW1lbnQsIEVsZW1lbnQsIE5vZGVMaXN0LCBmYWxzZV1cblx0fSkocmVxdWlyZSgneG1sZG9tJykpKVxufVxuIl19